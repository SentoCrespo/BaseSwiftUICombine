# ---------------------------------
# TV target
# ---------------------------------

targets:
  ProjectTV:

    ## Scheme
    scheme:
      testTargets:
        - ProjectTVTests
      gatherCoverageData: true

    ## Properties
    type: application
    platform: [tvOS]
    platformSuffix: ''
    deploymentTarget:
      tvOS: 16.0
    
    ## Sources
    sources: 

      ### Autogeneration files
      # - path: AutoGenerated
      #   includes: 
      #     - "**/*.swift"

      # - path: AutoGenerated
      #   includes: 
      #     - "**/*.py"
      #   buildPhase: none

      # - path: AutoGenerated
      #   includes: 
      #     - Templates
      #   buildPhase: none

      ### Target files
      - path: ProjectTV
        excludes: 
          - Tests
          - "**/*_SPEC*.swift"
          - .swiftlint.yml
          - "**/*.swift.plist"
          - "**/*.config"
          - OtherResources/Info.plist
        
      ### Re-add info.plist without link
      - path: ProjectTV/OtherResources
        includes:
          - "Info.plist"
        buildPhase: none
        
      - path: ProjectTV
        includes:
          - "**/*.config"
        buildPhase: none
        
    ## Settings
    settings:
      base:
        SDKROOT: appletvos
        TARGETED_DEVICE_FAMILY: 3
        SUPPORTED_PLATFORMS: "appletvos appletvsimulator"
        PRODUCT_NAME: ProjectTV
        SWIFT_OBJC_BRIDGING_HEADER: $(SRCROOT)/ProjectTV/OtherResources/Project-Bridging-Header.h
        INFOPLIST_FILE: $(SRCROOT)/ProjectTV/OtherResources/Info.plist
        PRODUCT_BUNDLE_IDENTIFIER: com.sento.project.tv
        # CODE_SIGN_ENTITLEMENTS: Project/Project.entitlements
        ENABLE_BITCODE: NO
        GCC_PREFIX_HEADER: ProjectTV/OtherResources/Project-Prefix.pch
        CLANG_ENABLE_MODULES: YES
        USER_HEADER_SEARCH_PATHS: ../AppSpecialisation/ExternSource
        SKIP_INSTALL: NO
        OTHER_LDFLAGS: "$(inherited) -ObjC"

      ### Specific settings
      configs:
        Debug:
          # to ignore non-Arm64 dependencies
          EXCLUDED_SOURCE_FILE_NAMES[sdk=tvsimulator*]:
            # - sample.framework
          # ASSETCATALOG_COMPILER_APPICON_NAME: AppIcon-Debug
          VALIDATE_WORKSPACE: NO
          ENABLE_TESTABILITY: YES
          OTHER_SWIFT_FLAGS: "$(inherited) -D DEBUG"
          CODE_SIGN_IDENTITY: iPhone Developer
          DEVELOPMENT_ASSET_PATHS: "Project/PreviewContent"
          
        Release:
          VALIDATE_WORKSPACE: YES
          # ASSETCATALOG_COMPILER_APPICON_NAME: AppIcon-Release
          ASSETCATALOG_COMPILER_GENERATE_SWIFT_ASSET_SYMBOL_EXTENSIONS: YES
          CODE_SIGN_IDENTITY: iPhone Distribution

    ## Pre-build scripts phase
    buildToolPlugins:
     - plugin: RswiftGenerateInternalResources
       package: R.swift

    ## Pre-build scripts phase
    preBuildScripts:

      ### Code generation with Sourcery
      - name: Code Autogeneration
        script: |
                echo 'Generating Code...'
                ${SRCROOT}/../../Scripts/CodeGeneration/autoGenerateCodeConfig.py \
                  --sourceryBin '${SRCROOT}/../../Scripts/CodeGeneration/Sourcery-1.6.0/bin/sourcery' \
                  --config '${SRCROOT}/ProjectTV/AutoGenerated/Autogeneration.config'
        basedOnDependencyAnalysis: false

      ### Enforce style conventions
      - name: Swift Lint
        script: |
                ${SRCROOT}/../../Scripts/CodeLinting/swiftlint-0.44.0 \
                  --config ${SRCROOT}/.swiftlint.yml
        basedOnDependencyAnalysis: false
    
    ## Post-build scripts phase
    postBuildScripts:

      ### Crash-report system
      # - name: Crashlytics
      #   script: |
      #           ${BUILD_DIR%/Build/*}/SourcePackages/checkouts/firebase-ios-sdk/Crashlytics/run
      #   inputFiles: [
      #     "${DWARF_DSYM_FOLDER_PATH}/${DWARF_DSYM_FILE_NAME}/Contents/Resources/DWARF/${TARGET_NAME}",
      #     "$(SRCROOT)/$(BUILT_PRODUCTS_DIR)/$(INFOPLIST_PATH)"
      #   ]
      #   basedOnDependencyAnalysis: false
      
    ## Dependencies
    dependencies:

      ### iOS SDKs
      - sdk: Foundation.framework
      - sdk: SwiftUI.framework
         
      ### Other targets
      - target: Domain
      - target: Design
      - target: SharedUtils

      ### Swift Package Manager
      - package: R.swift
        product: RswiftLibrary
